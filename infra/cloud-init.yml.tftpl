#cloud-config
package_update: true

apt:
  sources:
    nodesource:
      source: "deb [signed-by=$KEY_FILE] https://deb.nodesource.com/node_lts.x nodistro main"
      keyid: "1655A0AB68576280"
      keyserver: "https://deb.nodesource.com/gpgkey/nodesource-repo.gpg.key"
    github-cli:
      source: "deb [arch=amd64 signed-by=$KEY_FILE] https://cli.github.com/packages stable main"
      keyid: "23F3D4EA75716059"
      keyserver: "https://cli.github.com/packages/githubcli-archive-keyring.gpg"

packages:
  - git
  - curl
  - zsh
  - jq
  - build-essential
  - unzip
  - ca-certificates
  - gnupg
  - nodejs
  - gh

write_files:
  - path: /root/.zshrc
    append: true
    defer: true
    content: |

      # Load environment variables from mounted secrets
      set -a; source /root/secrets/.env; set +a

      # Claude Code
      export PATH="$HOME/.claude/local/bin:$PATH"

      # uv (installed to ~/.local/bin)
      export PATH="$HOME/.local/bin:$PATH"

      # Fix GH_APP_PRIVATE_KEY_PATH for VM context
      export GH_APP_PRIVATE_KEY_PATH="/root/secrets/vm-claude-agent.pem"

runcmd:
  # Install tools not available via apt
  - curl -LsSf https://astral.sh/uv/install.sh | sh
  - curl -fsSL https://claude.ai/install.sh | bash
  - sh -c "$(curl -fsSL https://raw.githubusercontent.com/ohmyzsh/ohmyzsh/master/tools/install.sh)" "" --unattended
  # Configure shell and services
  - chsh -s /usr/bin/zsh root
  - |
    # Wait for workspace mount
    for i in $(seq 1 30); do
      mountpoint -q ${vm_mount_path} && break
      sleep 2
    done
  - |
    export PATH="/root/.claude/local/bin:/root/.local/bin:$PATH"
    claude mcp add --scope user context7 -- npx -y @upstash/context7-mcp@latest
    claude mcp add --scope user mcp-atlassian -- uvx mcp-atlassian
    claude mcp add --scope user ElevenLabs -- uvx elevenlabs-mcp
