#cloud-config

groups:
  - incus-admin

users:
  - default
  - name: john_smith
    groups: incus-admin, sudo
    shell: /bin/bash
    sudo: ALL=(ALL) NOPASSWD:ALL

write_files:
  - path: /etc/tool-versions.env
    content: |
      INCUS_VERSION=${incus_version}
      OPENTOFU_VERSION=${opentofu_version}
      GH_CLI_VERSION=${gh_cli_version}
      GH_TOKEN_VERSION=${gh_token_version}
  - path: /etc/profile.d/tool-versions.sh
    content: |
      set -a
      . /etc/tool-versions.env
      set +a
  - path: /etc/incus/init-config.yaml
    content: |
      config: {}
      networks:
      - name: incusbr0
        type: bridge
        config:
          ipv4.address: auto
          ipv4.nat: "true"
          ipv6.address: none
      storage_pools:
      - name: default
        driver: dir
      profiles:
      - name: default
        devices:
          root:
            path: /
            pool: default
            type: disk
          eth0:
            name: eth0
            network: incusbr0
            type: nic

package_update: true

packages:
  - git
  - curl
  - jq
  - gpg
  - just
  - unzip

runcmd:
  - |
    for i in $(seq 1 10); do
      mountpoint -q ${vm_mount_path} && break
      sleep 2
    done
  - bash /root/projects/vm_dev/infra/e2e_test_runner/scripts/setup_incus.sh
  - bash /root/projects/vm_dev/infra/e2e_test_runner/scripts/install_opentofu.sh
  - bash /root/projects/vm_dev/infra/common/scripts/install_gh_cli.sh
  - bash /root/projects/vm_dev/infra/common/scripts/install_gh_token.sh
