#cloud-config

groups:
  - incus-admin

users:
  - default
  - name: john_smith
    groups: incus-admin, sudo
    shell: /bin/bash
    sudo: ALL=(ALL) NOPASSWD:ALL

write_files:
  - path: /etc/tool-versions.env
    content: |
      INCUS_PIN=6.22
      OPENTOFU_VERSION=1.9.0
      GH_CLI_VERSION=2.87.3
      GH_TOKEN_VERSION=2.0.3
  - path: /etc/profile.d/tool-versions.sh
    content: |
      set -a
      . /etc/tool-versions.env
      set +a
  - path: /etc/incus/init-config.yaml
    content: |
      config: {}
      networks:
      - name: incusbr0
        type: bridge
        config:
          ipv4.address: auto
          ipv4.nat: "true"
          ipv6.address: none
      storage_pools:
      - name: default
        driver: dir
      profiles:
      - name: default
        devices:
          root:
            path: /
            pool: default
            type: disk
          eth0:
            name: eth0
            network: incusbr0
            type: nic

package_update: true

packages:
  - git
  - curl
  - jq
  - gpg
  - just

runcmd:
  - /root/projects/vm_dev/infra/scripts/host/setup-zabbly-repo.sh
  - /root/projects/vm_dev/infra/scripts/host/setup-incus.sh
  - /root/projects/vm_dev/infra/scripts/host/install-opentofu.sh
  - /root/projects/vm_dev/infra/scripts/host/install-gh-cli.sh
  - /root/projects/vm_dev/infra/scripts/host/install-gh-token.sh
