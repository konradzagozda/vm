#cloud-config

groups:
  - incus-admin

users:
  - default
  - name: testrunner
    groups: incus-admin, sudo
    shell: /bin/bash
    sudo: ALL=(ALL) NOPASSWD:ALL

write_files:
  - path: /etc/tool-versions
    content: |
      INCUS_PIN=6.22
      OPENTOFU_VERSION=1.9.0
      GH_CLI_VERSION=2.87.3
      GH_TOKEN_VERSION=2.0.3
  - path: /etc/profile.d/tool-versions.sh
    content: |
      set -a
      . /etc/tool-versions
      set +a
  - path: /etc/incus/init-config.yaml
    content: |
      config: {}
      networks:
      - name: incusbr0
        type: bridge
        config:
          ipv4.address: auto
          ipv4.nat: "true"
          ipv6.address: none
      storage_pools:
      - name: default
        driver: dir
      profiles:
      - name: default
        devices:
          root:
            path: /
            pool: default
            type: disk
          eth0:
            name: eth0
            network: incusbr0
            type: nic
  # KAN-21: Replace Zabbly repo with Incus install from source
  - path: /opt/host-scripts/setup-zabbly-repo.sh
    permissions: "0755"
    content: |
      #!/usr/bin/env bash
      set -eu
      . /etc/tool-versions
      curl -fsSL https://pkgs.zabbly.com/key.asc \
        | gpg --dearmor -o /usr/share/keyrings/zabbly.gpg
      echo "deb [arch=amd64 signed-by=/usr/share/keyrings/zabbly.gpg] https://pkgs.zabbly.com/incus/stable $(. /etc/os-release && echo "$VERSION_CODENAME") main" \
        > /etc/apt/sources.list.d/zabbly-incus.list
      cat > /etc/apt/preferences.d/pin-incus << PINEOF
      Package: incus incus-base incus-client
      Pin: version ${INCUS_PIN}.*
      Pin-Priority: 990
      PINEOF
  - path: /opt/host-scripts/setup-incus.sh
    permissions: "0755"
    content: |
      #!/usr/bin/env bash
      set -eu
      incus admin init --preseed < /etc/incus/init-config.yaml
  - path: /opt/host-scripts/install-opentofu.sh
    permissions: "0755"
    content: |
      #!/usr/bin/env bash
      set -eu
      . /etc/tool-versions
      curl --proto '=https' --tlsv1.2 -fsSL https://get.opentofu.org/install-opentofu.sh \
        | sh -s -- --install-method standalone --opentofu-version "$OPENTOFU_VERSION"
  - path: /opt/host-scripts/install-gh-cli.sh
    permissions: "0755"
    content: |
      #!/usr/bin/env bash
      set -eu
      . /etc/tool-versions
      curl -fsSL "https://github.com/cli/cli/releases/download/v${GH_CLI_VERSION}/gh_${GH_CLI_VERSION}_linux_amd64.tar.gz" \
        | tar -xz -C /usr/local --strip-components=1
  - path: /opt/host-scripts/install-gh-token.sh
    permissions: "0755"
    content: |
      #!/usr/bin/env bash
      set -eu
      . /etc/tool-versions
      curl -fsSL "https://github.com/Link-/gh-token/releases/download/v${GH_TOKEN_VERSION}/linux-amd64" \
        -o /usr/local/bin/gh-token
      chmod +x /usr/local/bin/gh-token

package_update: true

packages:
  - git
  - curl
  - jq
  - gpg
  - just

runcmd:
  - /opt/host-scripts/setup-zabbly-repo.sh
  - apt-get update && apt-get install -y incus incus-ui-canonical
  - /opt/host-scripts/setup-incus.sh
  - /opt/host-scripts/install-opentofu.sh
  - /opt/host-scripts/install-gh-cli.sh
  - /opt/host-scripts/install-gh-token.sh
