#cloud-config
package_update: true

packages:
  - git
  - curl
  - zsh
  - jq
  - build-essential
  - unzip
  - ca-certificates
  - gnupg

runcmd:
  # Install tools not available via apt
  - curl -fsSL https://deb.nodesource.com/setup_lts.x | bash -
  - apt-get install -y nodejs
  - |
    curl -fsSL https://cli.github.com/packages/githubcli-archive-keyring.gpg \
      | dd of=/usr/share/keyrings/githubcli-archive-keyring.gpg
    echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/githubcli-archive-keyring.gpg] https://cli.github.com/packages stable main" \
      | tee /etc/apt/sources.list.d/github-cli.list
    apt-get update
    apt-get install -y gh
  - |
    mkdir -p /root/.local/bin
    curl -fsSL https://github.com/Link-/gh-token/releases/latest/download/linux-amd64 \
      -o /root/.local/bin/gh-token
    chmod +x /root/.local/bin/gh-token
  - curl -LsSf https://astral.sh/uv/install.sh | sh
  - curl -fsSL https://claude.ai/install.sh | bash
  - sh -c "$(curl -fsSL https://raw.githubusercontent.com/ohmyzsh/ohmyzsh/master/tools/install.sh)" "" --unattended
  # Configure shell and services
  - chsh -s /usr/bin/zsh root
  - |
    cat > /etc/profile.d/vm-env.sh << 'EOF'
    # Load environment variables from mounted secrets
    set -a; source /root/secrets/.env; set +a

    # Claude Code
    export PATH="$HOME/.claude/local/bin:$PATH"

    # uv (installed to ~/.local/bin)
    export PATH="$HOME/.local/bin:$PATH"

    # Fix GH_APP_PRIVATE_KEY_PATH for VM context
    export GH_APP_PRIVATE_KEY_PATH="/root/secrets/key.pem"
    EOF
  - echo 'emulate sh -c "source /etc/profile"' >> /etc/zsh/zprofile
  - |
    # Wait for workspace mount
    for i in $(seq 1 10); do
      mountpoint -q ${vm_mount_path} && break
      sleep 2
    done
  - |
    export PATH="/root/.claude/local/bin:/root/.local/bin:$PATH"
    claude mcp add --scope user context7 -- npx -y @upstash/context7-mcp@latest
    claude mcp add --scope user mcp-atlassian -- uvx mcp-atlassian
    claude mcp add --scope user ElevenLabs -- uvx elevenlabs-mcp
